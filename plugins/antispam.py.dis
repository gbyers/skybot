from util import hook
import time, re

privmsg = {}
badwords = ["fuck"]

@hook.command
def addbadword(inp, input=None):
    if input.nick in ["nathan","cups"]:
        if inp.lower() not in badwords:
            time.sleep(1)
            badwords.append(inp.lower())
            return "Done"
        else:
            return "%s already in badwords"%inp.lower()

@hook.command
def delbadword(inp, input=None):
    if input.nick in ["nathan","cups"]:
        badwords.remove(inp)
        return "Done"

@hook.command
def badwordlist(inp, input=None):
    if input.nick in ["nathan","cups"]:
        return ", ".join(badwords)

@hook.event('PRIVMSG')
def _privmsg(inp, input=None, conn=None):
    chan = input.chan.lower()
    nick = input.nick.lower()
    bad = "("
    bad+= "|".join(badwords)
    bad+= ")"
    #for word in inp:
    m = re.search(bad,inp[1],re.I)
    if m: conn.cmd("KICK %s %s :Badword detected."%(input.chan,input.nick))
    #if word.lower() in badwords:
    #    conn.cmd("KICK %s %s :Badword detected."%(input.chan,input.nick))
    if not privmsg.has_key(chan):
        privmsg[chan] = {}
    if not privmsg[chan].has_key(nick):
        privmsg[chan][nick] = {"count": 1, "last": time.time(), "kicked": 0, "iskicked": 0}
    else:
        c = privmsg[chan][nick]["count"]
        l = privmsg[chan][nick]["last"]
        c = c+1-int(time.time() - l)
        if c < 0: c = 0
        privmsg[chan][nick]["count"] = c
        privmsg[chan][nick]["last"] = time.time()
        #if c >= 3 and privmsg[chan][nick]["kicked"] <= 2 and privmsg[chan][nick]["iskicked"] == 0:
        if c >= 3:
            conn.cmd("KICK %s %s :Don't spam here"%(chan,nick))
            #privmsg[chan][nick]["kicked"] = privmsg[chan][nick]["kicked"]+1
            #privmsg[chan][nick]["iskicked"] = 1
        #elif c >= 2 and privmsg[chan][nick]["kicked"] >= 3 and privmsg[chan][nick]["iskicked"] == 0:
        #    conn.cmd("MODE %s +b %s!*@%s.*"%(chan,nick,input.host.split(".",2)[-3]))
        #    privmsg[chan][nick]["kicked"] = 0
        #    privmsg[chan][nick]["iskicked"] = 0
        #elif c >= 5:
        #    conn.cmd("MODE %s +b %s!*@%s.*"%(chan,nick,input.host.split(".",2)[-3]))
        #    privmsg[chan][nick]["iskicked"] = 0
